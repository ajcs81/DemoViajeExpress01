
@{
    ViewData["Title"] = "Cooperativa";
    Layout = "~/Views/Shared/_LayoutDashboard.cshtml";
}

@section styles{
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
          integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
          crossorigin="" />
    <style>
        #map2 {
            min-height: 300px;
        }
    </style>
}
<div class="col-sm-12">
    <!-- Customer overview start -->
    <div class="card ">
        <div class="card-header">
            <button class="btn btn-round waves-light btn-primary" id="crear_cooperativa">
                <i class="fa fa-plus-square"></i>
                Nueva Cooperativa
            </button>

        </div>
        <div class="card-block">
            <div class="table-responsive dt-responsive">
                <table class="table table-striped table-bordered nowrap" id="tblCoop">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Teléfono</th>
                            <th>Dirección</th>
                            <th>Estado</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="formModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content" id="modalbody">

                <!-- Modal -->
                <div class="modal-header">
                    <h4 class="modal-title">Nueva Cooperativa</h4>
                    <button type="button" class="close"
                            data-dismiss="modal"
                            aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body">
                    <span id="form_result"></span>

                    <div id="wizardc">
                        <form id="cooperativa_form" method="post">
                            <div>
                                <h3>Datos Cooperativa</h3>
                                <section>
                                    <div class="row">
                                        <div class="col-sm-6">
                                            <div class="form-group row">
                                                <label class="col-sm-4 col-form-label">
                                                    Nombre
                                                </label>
                                                <div class="col-md-8">
                                                    <input type="text" id="nombre" name="nombre" class="form-control required">
                                                    <label class="error" style="color:red" for="nombre" id="nombre_error">El nombre es requerido.</label>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label class="col-sm-4 col-form-label">
                                                    Dirección
                                                </label>
                                                <div class="col-md-8">
                                                    <input type="text" id="direccion" name="direccion" class="form-control required">
                                                    <label class="error" style="color:red" for="direccion" id="direccion_error">La direccion es requerida.</label>

                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label class="col-sm-4 col-form-label">
                                                    Teléfono
                                                </label>
                                                <div class="col-md-8">
                                                    <input type="text" id="telefono" name="telefono" class="form-control required">
                                                    <label class="error" style="color:red" for="telefono" id="telefono_error">El telefono es requerido.</label>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label class="col-sm-4 col-form-label">
                                                    Latitud
                                                </label>
                                                <div class="col-md-8">
                                                    <input type="text" id="lat" name="lat" class="form-control required" disabled>
                                                    <label class="error" style="color:red" for="lat" id="lat_error">La latitud es requerida.</label>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label class="col-sm-4 col-form-label">
                                                    Longitud
                                                </label>
                                                <div class="col-md-8">
                                                    <input type="text" id="lng" name="lng" class="form-control required" disabled>
                                                    <label class="error" style="color:red" for="lng" id="lng_error">La longitud es requerida.</label>
                                                </div>

                                            </div>
                                            @*<div class="custom-control custom-switch">
                                                    <input type="checkbox" class="custom-control-input" id="customSwitch1">
                                                    <label class="custom-control-label" for="customSwitch1">Activar</label>
                                                </div>*@

                                        </div>
                                        <div class="col-sm-6">
                                            <div class="card">
                                                <div class="card-body" id="map2"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" name="action" id="action" value="Add" />
                                    <input type="hidden" name="hidden_id" id="hidden_id" />
                                    @*<div class="modal-footer">
                                            <input type="hidden" name="action" id="action" value="Add" />
                                            <input type="hidden" name="hidden_id" id="hidden_id" />
                                            <button type="button" class="btn btn-default waves-effect "
                                                    data-dismiss="modal">
                                                Cancelar
                                            </button>
                                            <button type="submit" name="action_button" id="action_button" class="btn btn-primary waves-effect waves-light "
                                                    value="Add">
                                                <i class="fa fa-save"></i> Guardar
                                            </button>
                                        </div>*@
                                </section>
                                <h3>Admin Cooperativa</h3>
                                <section>
                                    <div class="form-group row">
                                        <label class="col-sm-4 col-form-label">
                                            Nombre
                                        </label>
                                        <div class="col-md-8">
                                            <input type="text" id="nombre2" name="nombre2" class="form-control">
                                            <label class="error" style="color:red" for="nombre2" id="nombre_error2">El nombre es requerido.</label>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="col-sm-4 col-form-label">
                                            Dirección
                                        </label>
                                        <div class="col-md-8">
                                            <input type="text" id="direccion2" name="direccion2" class="form-control">
                                            <label class="error" style="color:red" for="direccion2" id="direccion_error2">La direccion es requerida.</label>

                                        </div>
                                    </div>
                                </section>
                            </div>
                        </form>
                    </div>


                </div>

            </div>
        </div>
    </div>
</div>
@section Scripts{

    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
            integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
            crossorigin=""></script>
    <script>

    </script>
    <script type="text/javascript">

        var datatable;
        var token;
        var id_usuario_rol;
        var map;
        let consult = {
            "offset": 0,
            "limit": 10
        }
        $(document).ready(function () {
            token = localStorage.getItem('id_token');
            id_usuario_rol = localStorage.getItem('id_usuario_rol');
            let listarmodulo = document.getElementById('modulos');
            var url = `http://localhost:59454/Modulo/ ${id_usuario_rol}`;
            fetch(url, {
                headers: {
                    'Content-Type': 'application/json',
                    'token': token,
                },
            })
                .then((response) => {
                    return response.json();
                })
                .then((data) => {
                    if (data['exito']) {
                        var modul = data['data'];
                        modul.forEach((item) => {
                            listarmodulo.innerHTML += `
                                                                                                                                <li class="">
                                                                                                                                <a onclick="navegar('${item['ruta']}')" class="waves-effect waves-dark">
                                                                                                                                    <span class="pcoded-micon">
                                                                                                                                          <i class="feather icon-command"></i>
                                                                                                                                     </span>
                                                                                                                                      <span class="pcoded-mtext">${item['descripcion_modulo']} </span>
                                                                                                                                </a>
                                                                                                                                </li>`
                        });
                    } else {
                        alert(data['mensaje']);
                    }

                }).catch((error) => alert(error));

            obtenerCoop();
        });

        var form = $("#cooperativa_form");
        form.children("div").steps({
            headerTag: "h3",
            bodyTag: "section",
            transitionEffect: "slideLeft",
            onStepChanging: function (event, currentIndex, newIndex) {
                form.validate().settings.ignore = ":hidden";
                return form.valid();
            },
            onFinished: function (event, currentIndex) {
                guardar();
            }
        });



        function obtenerCoop() {
            $.ajax({
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'token': token
                },
                url: 'http://localhost:59454/Cooperativa/Listar',
                type: "POST",
                data: JSON.stringify(consult),
                dataType: "json",
                success: function (data) {
                    datatable = $("#tblCoop").DataTable();
                    datatable.destroy();
                    // $('#tblCoop').empty();
                    datatable = $('#tblCoop').DataTable({
                        processing: false,
                        serverSide: false,
                        responsive: true,
                        autoWidth: false,
                        data: data['data'],
                        columns: [
                            { data: "nombre" },
                            { data: "direccion" },
                            { data: "telefono" },
                            {
                                data: "activo", "render": function (data) {
                                    if (data) {
                                        return "Activo"
                                    } else {
                                        return "Desactivo"
                                    }
                                }
                            },
                            {
                                data: "id_cooperativa", "render": function (data) {
                                    var id = data;
                                    return '<button type="button"  name="edit" id="' + id + '"  class="edit btn btn-primary btn-sm"> <i class="fa fa-edit fa-lg"></i></button> <button type="button"   name="delete" id="' + id + '" class="delete btn btn-danger btn-sm"><i class="fa fa-trash fa-lg"></i> </button>';
                                }
                            }
                        ]
                    });

                },
                error: function (err) {
                    console.log(err);
                }
            });
        }

        function navegar(ruta) {
            // console.log(`../${ruta}`);
            location.href = `../${ruta}`;
        }

        $('#crear_cooperativa').click(function () {
            $('.modal-title').text('Agregar nueva Cooperativa');
            $('#action_button').val('Add');
            $('#action').val('Add');
            $('#form_result').html('');
            $('#formModal').modal('show');
            $('.error').hide();
        });






        function guardar() {
            var nombre = $("input#nombre").val();
            var direccion = $("input#direccion").val();
            var telefono = $("input#telefono").val();
            var lat = $("input#lat").val();
            var lng = $("input#lng").val();
            var dataString = { "id_persona_rol_admin": id_usuario_rol, 'nombre': nombre, 'direccion': direccion, 'telefono': telefono, 'lat': lat, 'lng': lng, "activo": true };
            let id_coop = $('#hidden_id').val();
            let type_method = '';
            var action_url = '';
            if ($('#action').val() == 'Add') {
                action_url = "http://localhost:59454/Cooperativa";
                type_method = 'POST'
            }
            if ($('#action').val() == 'Edit') {
                action_url = "http://localhost:59454/Cooperativa/" + id_coop;
                type_method = 'PUT'
            }

            $.ajax({
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'token': token
                },
                url: action_url,
                type: type_method,
                data: JSON.stringify(dataString),
                dataType: "json",
                success: function (data) {
                    $('#formModal').modal('hide');
                    swal({
                        title: 'Correcto',
                        text: 'Transaccion procesada correctamente',
                        type: 'success',
                        timer: 1500,
                    });
                    obtenerCoop();
                    $('#cooperativa_form')[0].reset();
                },
                error: function (err) {
                    swal({
                        title: 'Error',
                        text: 'Transaccion procesada correctamente',
                        type: 'success',
                        timer: 1500,
                    });
                    // console.log(err);
                }
            });
            return false;
        }


        $('#cooperativa_form').on('submit', function (event) {

            $('.error').hide();
            var nombre = $("input#nombre").val();
            if (nombre == "") {
                $("label#nombre_error").show();
                $("input#nombre").focus();
                return false;
            }
            var direccion = $("input#direccion").val();
            if (direccion == "") {
                $("label#direccion_error").show();
                $("input#direccion").focus();
                return false;
            }
            var telefono = $("input#telefono").val();
            if (telefono == "") {
                $("label#telefono_error").show();
                $("input#telefono").focus();
                return false;
            }
            var lat = $("input#lat").val();
            if (lat == "") {
                $("label#lat_error").show();
                $("input#lat").focus();
                return false;
            }
            var lng = $("input#lng").val();
            if (lng == "") {
                $("label#lng_error").show();
                $("input#lng").focus();
                return false;
            }

            var dataString = { "id_persona_rol_admin": id_usuario_rol, 'nombre': nombre, 'direccion': direccion, 'telefono': telefono, 'lat': lat, 'lng': lng, "activo": true };
            console.log(dataString);
            let id_coop = $('#hidden_id').val();
            let type_method = '';
            var action_url = '';
            if ($('#action').val() == 'Add') {
                action_url = "http://localhost:59454/Cooperativa";
                type_method = 'POST'
                console.log('Hizo Post');
            }
            if ($('#action').val() == 'Edit') {
                action_url = "http://localhost:59454/Cooperativa/" + id_coop;
                type_method = 'PUT'
            }

            $.ajax({
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'token': token
                },
                url: action_url,
                type: type_method,
                data: JSON.stringify(dataString),
                dataType: "json",
                success: function (data) {
                    $('#formModal').modal('hide');
                    swal({
                        title: 'Correcto',
                        text: 'Transaccion procesada correctamente',
                        type: 'success',
                        timer: 1500,
                    });
                    $('#cooperativa_form')[0].reset();
                    obtenerCoop();
                },
                error: function (err) {
                    swal({
                        title: 'Error',
                        text: 'Transaccion procesada correctamente',
                        type: 'success',
                        timer: 1500,
                    });
                }
            });
            return false;
        });


        $(document).on('click', '.edit', function () {
            $('.error').hide();
            var id = $(this).attr('id');
            $('#form_result').html('');
            $.ajax({
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'token': token
                },
                url: "http://localhost:59454/Cooperativa/" + id,
                dataType: "json",
                success: function (resp) {
                    $('#nombre').val(resp.data.nombre);
                    $('#direccion').val(resp.data.direccion);
                    $('#telefono').val(resp.data.telefono);
                    $('#lat').val(resp.data.lat);
                    $('#lng').val(resp.data.lng);
                    $('#hidden_id').val(id);
                    $('.modal-title').text('Editar cooperativa');
                    $('#action_button').val('Edit');
                    $('#action').val('Edit');
                    $('#formModal').modal('show');
                }
            })
            return false;
        });


        $(document).on('click', '.delete', function () {
            let coop_id = $(this).attr('id');
            $.ajax({
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'token': token
                },
                url: "http://localhost:59454/Cooperativa/" + coop_id,
                dataType: "json",
                success: function (resp) {
                    let cooperativa = {
                        "nombre": resp.data.nombre,
                        "direccion": resp.data.direccion,
                        "telefono": resp.data.telefono,
                        "lat": resp.data.lat,
                        "lng": resp.data.lng,
                        "Deleted_by": id_usuario_rol
                    }
                    eliminarCoop(coop_id, cooperativa);

                }
            });
        });



        function eliminarCoop(id, dataCoop) {
            $.ajax({
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'token': token
                },
                url: "http://localhost:59454/Cooperativa/" + id,
                type: 'DELETE',
                dataType: "json",
                data: JSON.stringify(dataCoop),
                success: function (data) {
                    swal({
                        title: 'Correcto',
                        text: 'Transaccion procesada correctamente',
                        type: 'success',
                        timer: 1500,
                    });
                    obtenerCoop();
                },
                error: function (err) {
                    swal({
                        title: 'Error',
                        text: 'Transaccion procesada correctamente',
                        type: 'success',
                        timer: 1500,
                    });
                }
            });
        }

        //mapoa
        map = L.map('map2').setView([0.04104004628590023, -78.14285258539633], 13);
        //[0.04104004628590023, -78.14285258539633], 13

        L.marker([48.86, 2.35]).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Comment out the below code to see the difference.
        $('#formModal').on('shown.bs.modal', function () {
            map.invalidateSize();
        });
        var popup = L.popup();
        var txt_latitud = document.getElementById("lat");
        var txt_longitud = document.getElementById("lng");


        function onMapClick(e) {
            popup.setLatLng(e.latlng).setContent("Lugar seleccionado").openOn(map);
            txt_latitud.value = e.latlng.lat;
            txt_longitud.value = e.latlng.lng;
        }

        map.on('click', onMapClick);

    </script>

    @*<script>

            var datatable;
            var map;
            const action_url = 'http://localhost:59454/Cooperativa/Obtener';

            $(document).ready(function () {
                let consult = {
                    "offset": 0,
                    "limit": 10
                }




                $.ajax({
                    url: action_url,
                    method: "POST",
                    data: $(consult).serialize(),
                    dataType: "json",
                    success: function (data) {
                        console.log(data);
                    }
                });



                //datatable = $('#tblCoop').DataTable({
                //    processing: false,
                //    serverSide: false,
                //    responsive: true,
                //    autoWidth: false,
                //    ajax: {
                //        url: "http://localhost:59454/Cooperativa/Obtener",
                //        type: "POST",
                //        data: $(consult).serialize(),
                //        datatype: "json"
                //        success:
                //    },

                //    columns: [
                //        { data: "nombre" },
                //        { data: "direccion" },
                //        { data: "telefono" },
                //        { data: "activo" },
                //        {
                //            data: "id_cooperativa", "render": function (data) {
                //                var id = data;
                //                return '<button type="button" onclick="getCooperativa(' + id + ')"  class="edit btn btn-primary btn-sm"> <i class="fa fa-edit fa-lg"></i></button> <button type="button"  onclick="Eliminar(' + id + ')"  class="edit btn btn-danger btn-sm"><i class="fa fa-trash fa-lg"></i> </button>';
                //            }
                //        }
                //    ]
                //});




            });

        </script>*@
}
